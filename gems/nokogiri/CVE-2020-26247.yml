---
gem: nokogiri
cve: 2020-26247
ghsa: vr8q-g5c7-m54m
url: https://github.com/sparklemotion/nokogiri/security/advisories/GHSA-vr8q-g5c7-m54m
date: 2020-12-30
title: Nokogiri::XML::Schema trusts input by default, exposing risk of an XXE vulnerability
description: |-
  ### Description

  In Nokogiri versions <= 1.11.0.rc3, XML Schemas parsed by `Nokogiri::XML::Schema`
  are **trusted** by default, allowing external resources to be accessed over the
  network, potentially enabling XXE or SSRF attacks.

  This behavior is counter to
  the security policy followed by Nokogiri maintainers, which is to treat all input
  as **untrusted** by default whenever possible.

  Please note that this security
  fix was pushed into a new minor version, 1.11.x, rather than a patch release to
  the 1.10.x branch, because it is a breaking change for some schemas and the risk
  was assessed to be "Low Severity".

  ### Affected Versions

  Nokogiri `<= 1.10.10` as well as prereleases `1.11.0.rc1`, `1.11.0.rc2`, and `1.11.0.rc3`

  ### Mitigation

  There are no known workarounds for affected versions. Upgrade to Nokogiri
  `1.11.0.rc4` or later.

  If, after upgrading to `1.11.0.rc4` or later, you wish
  to re-enable network access for resolution of external resources (i.e., return to
  the previous behavior):

  1. Ensure the input is trusted. Do not enable this option
  for untrusted input.
  2. When invoking the `Nokogiri::XML::Schema` constructor,
  pass as the second parameter an instance of `Nokogiri::XML::ParseOptions` with the
  `NONET` flag turned off.

  So if your previous code was:

  ``` ruby
  # in v1.11.0.rc3 and earlier, this call allows resources to be accessed over the network
  # but in v1.11.0.rc4 and later, this call will disallow network access for external resources
  schema = Nokogiri::XML::Schema.new(schema)

  # in v1.11.0.rc4 and later, the following is equivalent to the code above
  # (the second parameter is optional, and this demonstrates its default value)
  schema = Nokogiri::XML::Schema.new(schema, Nokogiri::XML::ParseOptions::DEFAULT_SCHEMA)
  ```

  Then you can add the second parameter to indicate that the input is trusted by changing it to:

  ``` ruby
  # in v1.11.0.rc3 and earlier, this would raise an ArgumentError
  # but in v1.11.0.rc4 and later, this allows resources to be accessed over the network
  schema = Nokogiri::XML::Schema.new(trusted_schema, Nokogiri::XML::ParseOptions.new.nononet)
  ```
cvss_v3: 2.6
patched_versions:
- '>= 1.11.0.rc4'

related:
  url:
  - https://hackerone.com/reports/747489
